<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Change Membership Plan - Fitness Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
    .accent-text { color: #A3E635; }
    .btn-primary { background-color: #A3E635; color: #111827; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease; }
    .btn-primary:hover { background-color: #82c000; }
    .btn-secondary { background-color: #6B7280; color: #FFFFFF; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease; }
    .btn-secondary:hover { background-color: #4B5563; }
    .dashboard-nav a { display: block; padding: 0.75rem 1rem; border-radius: 0.375rem; color: #374151; transition: background-color 0.2s ease, color 0.2s ease; }
    .dashboard-nav a:hover { background-color: #e5e7eb; color: #111827; }
    .dashboard-nav a.active { background-color: #A3E635; color: #111827; font-weight: 600; }
    .plan-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 1.5rem; border: 2px solid transparent; transition: border-color 0.3s ease, transform 0.3s ease; }
    .plan-card.current { border-color: #1F2937; background-color: #f3f4f6; } /* Dark border for current */
    .plan-card.selected { border-color: #A3E635; transform: scale(1.03); box-shadow: 0 10px 15px -3px rgba(163,230,53,0.3); }
    .plan-card h3 { font-size: 1.25rem; font-weight: 700; }
    .plan-card .price { font-size: 1.875rem; font-weight: 800; }
  </style>
</head>
<body class="flex flex-col min-h-screen">
<header class="bg-white shadow-md sticky top-0 z-50">
  <div class="container mx-auto px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="text-2xl font-bold text-gray-800"><a href="../index.html">Fitness <span class="accent-text">Center</span></a></div>
      <nav class="hidden md:flex items-center space-x-6">
        <a href="../index.html" class="text-gray-700 hover:text-lime-500">Home</a>
        <a href="../schedule.html" class="text-gray-700 hover:text-lime-500">Classes</a>
        <a href="member_dashboard.html" class="text-gray-700 hover:text-lime-500 font-semibold">My Dashboard</a>
      </nav>
      <div class="flex items-center space-x-3">
        <span class="hidden sm:inline text-gray-700">Welcome, Jane!</span>
        <a href="../index.html" class="btn-secondary text-sm sm:text-base !px-3 !py-1.5">Logout</a>
      </div>
      <div class="md:hidden"><button id="mobile-menu-button" class="text-gray-800 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button></div>
    </div>
    <div id="mobile-menu" class="hidden md:hidden mt-3">
      <a href="index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Home</a>
      <a href="schedule.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Classes</a>
      <a href="member_dashboard.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded font-semibold">My Dashboard</a>
      <a href="index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Logout</a>
    </div>
  </div>
</header>

<main class="flex-grow container mx-auto px-6 py-12 md:py-16">
  <div class="md:flex md:space-x-8">
    <aside class="md:w-1/4 mb-8 md:mb-0">
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Member Menu</h3>
        <nav class="dashboard-nav space-y-1">
          <a href="member_dashboard.html"><i class="fas fa-tachometer-alt mr-2 w-5 text-center"></i>Overview</a>
          <a href="member_profile_update.html"><i class="fas fa-user-edit mr-2 w-5 text-center"></i>Update Profile</a>
          <a href="member_booked_classes.html"><i class="fas fa-calendar-check mr-2 w-5 text-center"></i>My Bookings</a>
          <a href="member_membership_details.html"><i class="fas fa-id-card mr-2 w-5 text-center"></i>Membership</a>
          <a href="member_payment_history.html"><i class="fas fa-history mr-2 w-5 text-center"></i>Payment History</a>
          <a href="member_upgrade_downgrade.html" class="active"><i class="fas fa-level-up-alt mr-2 w-5 text-center"></i>Change Plan</a>
          <a href="member_feedback_form.html"><i class="fas fa-comment-dots mr-2 w-5 text-center"></i>Submit Feedback</a>

        </nav>
      </div>
    </aside>

    <section class="md:w-3/4">
      <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl">
        <div class="mb-8">
          <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">
            Change Your <span class="accent-text">Membership Plan</span>
          </h1>
          <p class="mt-2 text-gray-600">Upgrade or adjust your plan to better suit your fitness goals.</p>
        </div>

        <div class="mb-6 p-4 bg-blue-50 border border-blue-300 rounded-md">
          <p class="text-sm text-blue-700"><i class="fas fa-info-circle mr-2"></i>Your current plan is: <strong id="currentPlanName">Premium Plus</strong>. It renews on <strong id="renewalDate">June 15, 2025</strong>.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="availablePlansContainer">
        </div>

        <div id="summarySection" class="hidden mt-8 p-6 bg-gray-50 rounded-lg border">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Change Summary</h2>
          <div id="summaryDetails" class="space-y-2 text-gray-700">
          </div>
          <div class="mt-6">
            <label for="confirmChange" class="flex items-center text-sm">
              <input type="checkbox" id="confirmChange" name="confirmChange" class="h-4 w-4 text-lime-600 border-gray-300 rounded focus:ring-lime-500 mr-2">
              I understand that my billing will be adjusted accordingly, and the new plan will take effect <span id="effectiveDateText">immediately upon confirmation</span>.
            </label>
          </div>
          <button id="confirmPlanChangeBtn" class="btn-primary w-full mt-6 text-lg" disabled>Confirm Plan Change</button>
          <p id="changeMessage" class="mt-4 text-center text-sm"></p>
        </div>
        <p id="noOtherPlansMessage" class="text-center text-gray-500 mt-8 hidden">There are no other plans available to switch to at this moment, or you are already on the highest/lowest tier.</p>
      </div>
    </section>
  </div>
</main>

<footer class="bg-gray-800 text-gray-300 py-12 mt-auto">
  <div class="container mx-auto px-6 text-center">
    <p>&copy; <span id="currentYear"></span> Fitness Center. All Rights Reserved.</p>
  </div>
</footer>

<script>
  // API Base URL
  const API_BASE_URL = 'http://localhost:8080/api'; // Adjust port if needed

  // DOM Elements
  const availablePlansContainer = document.getElementById('availablePlansContainer');
  const currentPlanNameEl = document.getElementById('currentPlanName');
  const renewalDateEl = document.getElementById('renewalDate'); // Assuming this is static or fetched elsewhere for now
  const summarySection = document.getElementById('summarySection');
  const summaryDetails = document.getElementById('summaryDetails');
  const confirmChangeCheckbox = document.getElementById('confirmChange');
  const confirmPlanChangeBtn = document.getElementById('confirmPlanChangeBtn');
  const effectiveDateText = document.getElementById('effectiveDateText'); // In summary
  const changeMessage = document.getElementById('changeMessage'); // For success/error messages
  const noOtherPlansMessage = document.getElementById('noOtherPlansMessage');

  let currentMemberId = null;
  let authToken = null;
  let currentUserPlan = null; // To store the member's current plan details
  let allAvailablePlans = []; // To store all plans fetched from API
  let selectedPlanForChange = null; // To store the plan the user selects to change to

  function checkLoginStatusAndLoadData() {
      authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
      currentMemberId = localStorage.getItem('memberId') || sessionStorage.getItem('memberId');

      if (!authToken || !currentMemberId) {
          alert('You must be logged in to manage your membership. Redirecting to login...');
          window.location.href = '../login.html'; // Adjust path
          return;
      }
      fetchMemberAndPlanData();
  }

  async function fetchMemberAndPlanData() {
      if (!currentMemberId || !authToken) return;

      try {
          // Fetch member's current details (including their planId)
          const memberResponse = await fetch(`${API_BASE_URL}/members/${currentMemberId}`, {
              headers: { 'X-Auth-Token': authToken }
          });
          if (!memberResponse.ok) throw new Error(`Failed to fetch member details: ${memberResponse.statusText}`);
          const member = await memberResponse.json();

          // Fetch all available plans
          const plansResponse = await fetch(`${API_BASE_URL}/plans`, {
              headers: { 'X-Auth-Token': authToken } // Assuming plans API might also be protected
          });
          if (!plansResponse.ok) throw new Error(`Failed to fetch plans: ${plansResponse.statusText}`);
          allAvailablePlans = (await plansResponse.json()).filter(plan => plan.status === 'active');


          // Find the member's current plan details from allAvailablePlans
          if (member.membershipTierId) {
              currentUserPlan = allAvailablePlans.find(p => p.id === member.membershipTierId);
          }

          if (currentUserPlan) {
              if (currentPlanNameEl) currentPlanNameEl.textContent = currentUserPlan.name;
              // renewalDateEl might be more complex, e.g., fetched from a subscription record
              if (renewalDateEl) renewalDateEl.textContent = "Next Billing Date"; // Placeholder
          } else {
              if (currentPlanNameEl) currentPlanNameEl.textContent = "N/A (No active plan found)";
          }

          renderAvailablePlans();

      } catch (error) {
          console.error('Error fetching data:', error);
          if (changeMessage) changeMessage.innerHTML = `<p class="text-red-500">Could not load your membership data. ${error.message}</p>`;
          if (availablePlansContainer) availablePlansContainer.innerHTML = '';
      }
  }


  function renderAvailablePlans() {
      if (!availablePlansContainer) return;
      availablePlansContainer.innerHTML = '';
      let otherPlansExist = false;

      allAvailablePlans.forEach(plan => {
          const isCurrent = currentUserPlan && plan.id === currentUserPlan.id;
          const cardClasses = `plan-card cursor-pointer ${isCurrent ? 'current opacity-70' : 'hover:border-lime-500'}`;

          const featuresList = plan.description ? plan.description.split(',')
              .map(f => `<li><i class="fas fa-check text-xs mr-2 ${isCurrent ? 'text-gray-600' : 'text-lime-500'}"></i>${f.trim()}</li>`).join('')
              : '<li>No specific features listed.</li>';

          const cardHTML = `
              <div id="plan-${plan.id}" class="${cardClasses}" data-plan-id="${plan.id}">
                  <h3 class="text-gray-800">${plan.name}</h3>
                  <p class="price ${isCurrent ? 'text-gray-700' : 'accent-text'} mb-2">Rs.${plan.price.toFixed(2)}<span class="text-sm font-normal ${isCurrent ? 'text-gray-500' : 'text-gray-600'}">/${plan.duration || 'mo'}</span></p>
                  <ul class="text-xs text-gray-600 space-y-1 mb-3 min-h-[60px]">${featuresList}</ul>
                  ${isCurrent ? '<p class="text-center text-sm font-semibold text-gray-700 py-2 bg-gray-200 rounded-md">Your Current Plan</p>' : `<button class="btn-primary w-full text-sm !py-2 select-plan-btn" data-plan-id="${plan.id}">Select Plan</button>`}
              </div>
          `;
          availablePlansContainer.innerHTML += cardHTML;
          if (!isCurrent) otherPlansExist = true;
      });

      if (noOtherPlansMessage) {
          noOtherPlansMessage.style.display = otherPlansExist ? 'none' : 'block';
      }

      document.querySelectorAll('.select-plan-btn').forEach(button => {
          button.addEventListener('click', function(event) {
              event.stopPropagation(); // Prevent card click if button is separate
              handlePlanSelection(this.dataset.planId);
          });
      });
       // Add click listener to cards that are not current
      document.querySelectorAll('.plan-card:not(.current)').forEach(card => {
          card.addEventListener('click', function() {
              handlePlanSelection(this.dataset.planId);
          });
      });
  }

  function handlePlanSelection(planId) {
      selectedPlanForChange = allAvailablePlans.find(p => p.id === planId);
      if (!selectedPlanForChange || (currentUserPlan && selectedPlanForChange.id === currentUserPlan.id)) {
          // Clear selection or do nothing if current plan is clicked (though button is hidden for current)
          if (summarySection) summarySection.classList.add('hidden');
          document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
          selectedPlanForChange = null;
          return;
      }

      document.querySelectorAll('.plan-card').forEach(card => card.classList.remove('selected'));
      const selectedCard = document.getElementById(`plan-${planId}`);
      if (selectedCard) selectedCard.classList.add('selected');

      if (summarySection && summaryDetails && currentUserPlan) {
          summarySection.classList.remove('hidden');
          const priceDifference = selectedPlanForChange.price - currentUserPlan.price;
          let summaryText = `
              <p><strong>From:</strong> ${currentUserPlan.name} (Rs.${currentUserPlan.price.toFixed(2)}/${currentUserPlan.duration || 'mo'})</p>
              <p><strong>To:</strong> ${selectedPlanForChange.name} (Rs.${selectedPlanForChange.price.toFixed(2)}/${selectedPlanForChange.duration || 'mo'})</p>
          `;
          if (priceDifference > 0) {
              summaryText += `<p class="text-green-600"><strong>Additional Cost:</strong> Rs.${priceDifference.toFixed(2)} (prorated charges may apply)</p>`;
              if (effectiveDateText) effectiveDateText.textContent = "immediately upon confirmation, with adjusted charges applied.";
          } else if (priceDifference < 0) {
              summaryText += `<p class="text-blue-600"><strong>Savings:</strong> Rs.${Math.abs(priceDifference).toFixed(2)} (credit may be applied to next bill)</p>`;
               if (effectiveDateText) effectiveDateText.textContent = "from the next billing cycle.";
          } else {
              summaryText += `<p>No change in monthly cost, but features will update.</p>`;
               if (effectiveDateText) effectiveDateText.textContent = "immediately upon confirmation.";
          }
          summaryDetails.innerHTML = summaryText;
      }
      if (confirmChangeCheckbox) confirmChangeCheckbox.checked = false;
      if (confirmPlanChangeBtn) confirmPlanChangeBtn.disabled = true;
      if (changeMessage) changeMessage.textContent = '';
  }

  if (confirmChangeCheckbox) {
      confirmChangeCheckbox.addEventListener('change', function() {
          if (confirmPlanChangeBtn) confirmPlanChangeBtn.disabled = !this.checked || !selectedPlanForChange;
      });
  }

  if (confirmPlanChangeBtn) {
      confirmPlanChangeBtn.addEventListener('click', async function() {
          if (!selectedPlanForChange || !confirmChangeCheckbox.checked || !currentMemberId || !authToken) {
              if (changeMessage) changeMessage.innerHTML = `<p class="text-red-500">Please select a plan and confirm understanding.</p>`;
              return;
          }

          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Changing Plan...';
          if (changeMessage) changeMessage.textContent = '';

          try {
              // API call to update member's membershipTierId
              const response = await fetch(`${API_BASE_URL}/members/${currentMemberId}`, {
                  method: 'PUT',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-Auth-Token': authToken
                  },
                  body: JSON.stringify({ membershipTierId: selectedPlanForChange.id }) // Only send the field to be updated
              });

              if (response.ok) {
                  // const updatedMember = await response.json();
                  if (changeMessage) changeMessage.innerHTML = `<p class="text-green-600">Successfully changed plan to ${selectedPlanForChange.name}! Details updated.</p>`;

                  // Simulate update and re-render
                  currentUserPlan = selectedPlanForChange; // Update local current plan
                  if (currentPlanNameEl) currentPlanNameEl.textContent = currentUserPlan.name;
                  // Update localStorage if plan name is stored there for display elsewhere
                  (localStorage.getItem('authToken') ? localStorage : sessionStorage).setItem('membershipPlanName', currentUserPlan.name);


                  renderAvailablePlans(); // Re-render plans to reflect current
                  if (summarySection) summarySection.classList.add('hidden');
                  selectedPlanForChange = null;
                  if (confirmChangeCheckbox) confirmChangeCheckbox.checked = false;
                  alert(`Your membership plan has been changed to ${currentUserPlan.name}.`);

              } else {
                  const errorText = await response.text();
                  if (changeMessage) changeMessage.innerHTML = `<p class="text-red-500">Failed to change plan: ${errorText || response.statusText}</p>`;
              }
          } catch (error) {
              console.error('Error changing plan:', error);
              if (changeMessage) changeMessage.innerHTML = `<p class="text-red-500">An error occurred while changing your plan. ${error.message}</p>`;
          } finally {
              this.disabled = false;
              this.innerHTML = 'Confirm Plan Change';
          }
      });
  }

  // Mobile menu toggle & common footer/header logic
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
  }
  const currentYearElement = document.getElementById('currentYear');
  if (currentYearElement) {
      currentYearElement.textContent = new Date().getFullYear();
  }
  const welcomeSpan = document.querySelector('header span.text-gray-700');
  if (welcomeSpan) {
      const userName = localStorage.getItem('fullName') || sessionStorage.getItem('fullName');
      if (userName) welcomeSpan.textContent = `Welcome, ${userName.split(' ')[0]}!`;
  }
  const logoutButton = document.querySelector('header a.btn-secondary');
  if (logoutButton && logoutButton.textContent.toLowerCase() === 'logout') {
      logoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.clear(); sessionStorage.clear();
          window.location.href = '../login.html'; // Adjust path
      });
  }

  window.addEventListener('DOMContentLoaded', checkLoginStatusAndLoadData);
</script>
</body>
</html>
