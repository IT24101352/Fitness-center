<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Profile - Fitness Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f9fafb; /* Light gray background */
    }
    .accent-text {
        color: #A3E635; /* Lime Green */
    }
    .btn-primary {
        background-color: #A3E635;
        color: #111827; /* Dark text on lime button */
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
        background-color: #82c000; /* Darker lime */
    }
    .btn-secondary {
        background-color: #6B7280; /* Gray-500 */
        color: #FFFFFF;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: background-color 0.3s ease;
    }
    .btn-secondary:hover {
        background-color: #4B5563; /* Gray-600 */
    }
    .form-input {
        border-radius: 0.375rem; /* 6px */
        border: 1px solid #D1D5DB; /* Gray-300 */
        padding: 0.75rem 1rem; /* 12px 16px */
        width: 100%;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .form-input:focus {
        border-color: #A3E635;
        box-shadow: 0 0 0 3px rgba(163, 230, 53, 0.3); /* Lime focus ring */
        outline: none;
    }
    .form-label {
        display: block;
        margin-bottom: 0.5rem; /* 8px */
        font-weight: 500;
        color: #374151; /* Gray-700 */
    }
    /* Basic member dashboard styling */
    .dashboard-nav a {
        display: block;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        color: #374151; /* Gray-700 */
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .dashboard-nav a:hover {
        background-color: #e5e7eb; /* Gray-200 */
        color: #111827; /* Gray-900 */
    }
    .dashboard-nav a.active {
        background-color: #A3E635;
        color: #111827;
        font-weight: 600;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">
<header class="bg-white shadow-md sticky top-0 z-50">
  <div class="container mx-auto px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="text-2xl font-bold text-gray-800">
        <a href="../index.html">Fitness <span class="accent-text">Center</span></a>
      </div>
      <nav class="hidden md:flex items-center space-x-6">
        <a href="../index.html" class="text-gray-700 hover:text-lime-500">Home</a>
        <a href="../schedule.html" class="text-gray-700 hover:text-lime-500">Classes</a>
        <a href="member_dashboard.html" class="text-gray-700 hover:text-lime-500 font-semibold">My Dashboard</a>
      </nav>
      <div class="flex items-center space-x-3">
        <span class="hidden sm:inline text-gray-700">Welcome, Jane!</span> <a href="index.html" class="btn-secondary text-sm sm:text-base !px-3 !py-1.5">Logout</a>
      </div>
      <div class="md:hidden">
        <button id="mobile-menu-button" class="text-gray-800 focus:outline-none">
          <i class="fas fa-bars fa-lg"></i>
        </button>
      </div>
    </div>
    <div id="mobile-menu" class="hidden md:hidden mt-3">
      <a href="../index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Home</a>
      <a href="../schedule.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Classes</a>
      <a href="member_dashboard.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded font-semibold">My Dashboard</a>
      <a href="index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Logout</a>
    </div>
  </div>
</header>

<main class="flex-grow container mx-auto px-6 py-12 md:py-16">
  <div class="md:flex md:space-x-8">
    <aside class="md:w-1/4 mb-8 md:mb-0">
      <div class="bg-white p-6 rounded-xl shadow-lg">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Member Menu</h3>
        <nav class="dashboard-nav space-y-1">
          <a href="member_dashboard.html"><i class="fas fa-tachometer-alt mr-2 w-5 text-center"></i>Overview</a>
          <a href="member_profile_update.html" class="active"><i class="fas fa-user-edit mr-2 w-5 text-center"></i>Update Profile</a>
          <a href="member_booked_classes.html"><i class="fas fa-calendar-check mr-2 w-5 text-center"></i>My Bookings</a>
          <a href="member_membership_details.html"><i class="fas fa-id-card mr-2 w-5 text-center"></i>Membership</a>
          <a href="member_payment_history.html"><i class="fas fa-history mr-2 w-5 text-center"></i>Payment History</a>
          <a href="member_upgrade_downgrade.html"><i class="fas fa-level-up-alt mr-2 w-5 text-center"></i>Change Plan</a>
          <a href="member_feedback_form.html"><i class="fas fa-comment-dots mr-2 w-5 text-center"></i>Submit Feedback</a>

        </nav>
      </div>
    </aside>

    <section class="md:w-3/4">
      <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl">
        <div class="mb-8">
          <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">
            Update Your <span class="accent-text">Profile</span>
          </h1>
          <p class="mt-2 text-gray-600">Keep your personal information and preferences up to date.</p>
        </div>

        <form id="profileUpdateForm" action="#" method="POST" class="space-y-6">
          <div>
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Personal Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="fullName" class="form-label">Full Name</label>
                <input type="text" name="fullName" id="fullName" class="form-input" value="Jane Doe" required>
              </div>
              <div>
                <label for="email" class="form-label">Email Address</label>
                <input type="email" name="email" id="email" class="form-input" value="jane.doe@example.com" required>
              </div>
              <div>
                <label for="phone" class="form-label">Phone Number</label>
                <input type="tel" name="phone" id="phone" class="form-input" value="(123) 456-7890">
              </div>
              <div>
                <label for="dob" class="form-label">Date of Birth</label>
                <input type="date" name="dob" id="dob" class="form-input" value="1990-05-15" required>
              </div>
              <div class="md:col-span-2">
                <label for="address" class="form-label">Address (Optional)</label>
                <input type="text" name="address" id="address" class="form-input" placeholder="123 Main St, Anytown, USA">
              </div>
            </div>
          </div>

          <div>
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Change Password</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="currentPassword" class="form-label">Current Password</label>
                <input type="password" name="currentPassword" id="currentPassword" class="form-input" placeholder="Enter current password">
              </div>
              <div>
                <label for="newPassword" class="form-label">New Password</label>
                <input type="password" name="newPassword" id="newPassword" class="form-input" placeholder="Enter new password">
              </div>
              <div>
                <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                <input type="password" name="confirmNewPassword" id="confirmNewPassword" class="form-input" placeholder="Confirm new password">
              </div>
            </div>
          </div>

          <div>
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Preferences</h2>
            <div>
              <label for="communicationPreference" class="form-label">Communication Preferences</label>
              <select name="communicationPreference" id="communicationPreference" class="form-input">
                <option value="email_newsletter">Email Newsletter & Updates</option>
                <option value="sms_reminders">SMS Reminders for Classes</option>
                <option value="all">All Communications</option>
                <option value="none">No Promotional Communications</option>
              </select>
            </div>
          </div>


          <div class="pt-6 flex flex-col sm:flex-row sm:justify-end space-y-3 sm:space-y-0 sm:space-x-4">
            <button type="button" class="btn-secondary">Cancel</button>
            <button type="submit" class="btn-primary">Save Changes</button>
          </div>
          <div id="formMessage" class="mt-4 text-center"></div>

        </form>
      </div>
    </section>
  </div>
</main>

<footer class="bg-gray-800 text-gray-300 py-12 mt-auto">
  <div class="container mx-auto px-6 text-center">
    <p>&copy; <span id="currentYear"></span> Fitness Center. All Rights Reserved.</p>
  </div>
</footer>

<script>
  // API Base URL
  const API_BASE_URL = 'http://localhost:8080/api'; // Adjust port if needed

  // DOM Elements
  const profileUpdateForm = document.getElementById('profileUpdateForm');
  const formMessage = document.getElementById('formMessage');
  const fullNameInput = document.getElementById('fullName');
  const emailInput = document.getElementById('email');
  const phoneInput = document.getElementById('phone');
  const dobInput = document.getElementById('dob');
  const addressInput = document.getElementById('address'); // Assuming you add this to your Member model if needed
  const currentPasswordInput = document.getElementById('currentPassword');
  const newPasswordInput = document.getElementById('newPassword');
  const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
  const communicationPreferenceSelect = document.getElementById('communicationPreference'); // If you implement this preference

  let currentMemberId = null;
  let authToken = null;
  let originalEmail = ''; // To check if email has changed

  function checkLoginStatusAndLoadProfile() {
      authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
      currentMemberId = localStorage.getItem('memberId') || sessionStorage.getItem('memberId');

      if (!authToken || !currentMemberId) {
          alert('You must be logged in to update your profile. Redirecting to login...');
          window.location.href = '../login.html'; // Adjust path
          return;
      }
      fetchMemberProfile();
  }

  async function fetchMemberProfile() {
      if (!currentMemberId || !authToken) return;

      try {
          const response = await fetch(`${API_BASE_URL}/members/${currentMemberId}`, {
              headers: { 'X-Auth-Token': authToken }
          });
          if (!response.ok) {
              if (response.status === 401 || response.status === 403) {
                   alert('Session expired or invalid. Please log in again.');
                   window.location.href = '../login.html';
              }
              throw new Error(`Failed to fetch profile: ${response.statusText}`);
          }
          const member = await response.json();
          populateForm(member);
      } catch (error) {
          console.error('Error fetching profile:', error);
          if (formMessage) formMessage.innerHTML = `<p class="text-red-500">Could not load your profile data. ${error.message}</p>`;
      }
  }

  function populateForm(member) {
      if (fullNameInput) fullNameInput.value = member.fullName || '';
      if (emailInput) {
          emailInput.value = member.email || '';
          originalEmail = member.email || ''; // Store original email
      }
      if (phoneInput) phoneInput.value = member.phone || '';
      if (dobInput) dobInput.value = member.dateOfBirth || ''; // Ensure backend sends YYYY-MM-DD
      if (addressInput && member.address) addressInput.value = member.address; // If you add address to model
      // communicationPreferenceSelect - populate if you store this preference
  }

  if (profileUpdateForm) {
      profileUpdateForm.addEventListener('submit', async function(event) {
          event.preventDefault();
          if (formMessage) formMessage.innerHTML = '';

          const newPassword = newPasswordInput.value;
          const confirmNewPassword = confirmNewPasswordInput.value;
          const currentPassword = currentPasswordInput.value;

          if (newPassword && newPassword !== confirmNewPassword) {
              if (formMessage) formMessage.innerHTML = '<p class="text-red-500">New passwords do not match. Please try again.</p>';
              if (confirmNewPasswordInput) confirmNewPasswordInput.focus();
              return;
          }

          // If new password is set, current password must also be provided (for backend validation)
          if (newPassword && !currentPassword) {
               if (formMessage) formMessage.innerHTML = '<p class="text-red-500">Please enter your current password to change it.</p>';
              if (currentPasswordInput) currentPasswordInput.focus();
              return;
          }


          const updatedMemberData = {
              fullName: fullNameInput.value,
              email: emailInput.value,
              phone: phoneInput.value,
              dateOfBirth: dobInput.value,
              // address: addressInput ? addressInput.value : undefined,
              // communicationPreference: communicationPreferenceSelect ? communicationPreferenceSelect.value : undefined
          };

          // Only include password if it's being changed
          if (newPassword) {
              // The backend should ideally verify the currentPassword before accepting a new one.
              // For this simple setup, we'll send the newPassword.
              // The backend MemberService update logic should handle hashing if implemented.
              updatedMemberData.password = newPassword;
              // You might want to send currentPassword too if your backend API needs it for verification
              // updatedMemberData.currentPassword = currentPassword;
          }


          if (formMessage) formMessage.innerHTML = '<p class="text-blue-500">Updating profile...</p>';

          try {
              const response = await fetch(`${API_BASE_URL}/members/${currentMemberId}`, {
                  method: 'PUT',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-Auth-Token': authToken
                  },
                  body: JSON.stringify(updatedMemberData)
              });

              if (response.ok) {
                  const updatedMember = await response.json();
                  if (formMessage) formMessage.innerHTML = '<p class="text-green-500">Profile updated successfully!</p>';
                  originalEmail = updatedMember.email; // Update originalEmail if changed
                  // Clear password fields
                  if(currentPasswordInput) currentPasswordInput.value = '';
                  if(newPasswordInput) newPasswordInput.value = '';
                  if(confirmNewPasswordInput) confirmNewPasswordInput.value = '';

                  // Update name in localStorage/sessionStorage if changed
                  const storedFullName = localStorage.getItem('fullName') || sessionStorage.getItem('fullName');
                  if (updatedMember.fullName !== storedFullName) {
                       (localStorage.getItem('authToken') ? localStorage : sessionStorage).setItem('fullName', updatedMember.fullName);
                  }


              } else {
                  const errorText = await response.text();
                  if (formMessage) formMessage.innerHTML = `<p class="text-red-500">Update failed: ${errorText || response.statusText}</p>`;
              }
          } catch (error) {
              console.error('Profile update error:', error);
              if (formMessage) formMessage.innerHTML = '<p class="text-red-500">An error occurred. Please try again later.</p>';
          }
      });
  }

  // Cancel button functionality (if you have one)
  const cancelButton = profileUpdateForm ? profileUpdateForm.querySelector('button[type="button"].btn-secondary') : null;
  if (cancelButton) {
      cancelButton.addEventListener('click', () => {
          // Optionally, redirect or just clear the form to original values
          fetchMemberProfile(); // Re-fetch to reset form
          if (formMessage) formMessage.innerHTML = '';
          if(currentPasswordInput) currentPasswordInput.value = '';
          if(newPasswordInput) newPasswordInput.value = '';
          if(confirmNewPasswordInput) confirmNewPasswordInput.value = '';
      });
  }


  // Mobile menu toggle
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');
  if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => {
          mobileMenu.classList.toggle('hidden');
      });
  }

  const currentYearElement = document.getElementById('currentYear');
  if (currentYearElement) {
      currentYearElement.textContent = new Date().getFullYear();
  }

  // Welcome message (could be in a shared header script)
  const welcomeSpan = document.querySelector('header span.text-gray-700');
  if (welcomeSpan) {
      const userName = localStorage.getItem('fullName') || sessionStorage.getItem('fullName');
      if (userName) {
          welcomeSpan.textContent = `Welcome, ${userName.split(' ')[0]}!`; // Display first name
      }
  }

  // Logout button (could be in a shared header script)
  const logoutButton = document.querySelector('header a.btn-secondary'); // Assuming this is the logout button
  if (logoutButton && logoutButton.textContent.toLowerCase() === 'logout') {
      logoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem('authToken');
          localStorage.removeItem('memberId');
          localStorage.removeItem('fullName');
          localStorage.removeItem('userEmail');
          localStorage.removeItem('userRole');
          sessionStorage.clear(); // Clear session storage too
          window.location.href = '../login.html'; // Adjust path
      });
  }


  window.addEventListener('DOMContentLoaded', checkLoginStatusAndLoadProfile);
</script>
</body>
</html>
