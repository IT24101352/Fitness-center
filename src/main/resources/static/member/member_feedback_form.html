<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Feedback - Fitness Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        .accent-text { color: #A3E635; }
        .btn-primary { background-color: #A3E635; color: #111827; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #82c000; }
        .btn-secondary { background-color: #6B7280; color: #FFFFFF; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s ease; }
        .btn-secondary:hover { background-color: #4B5563; }
        .dashboard-nav a { display: block; padding: 0.75rem 1rem; border-radius: 0.375rem; color: #374151; transition: background-color 0.2s ease, color 0.2s ease; }
        .dashboard-nav a:hover { background-color: #e5e7eb; color: #111827; }
        .dashboard-nav a.active { background-color: #A3E635; color: #111827; font-weight: 600; }
        .form-input { border-radius: 0.375rem; border: 1px solid #D1D5DB; padding: 0.75rem 1rem; width: 100%; transition: border-color 0.3s ease, box-shadow 0.3s ease; }
        .form-input:focus { border-color: #A3E635; box-shadow: 0 0 0 3px rgba(163, 230, 53, 0.3); outline: none; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .rating input[type="radio"] { display: none; }
        .rating label { font-size: 1.75rem; color: #D1D5DB; cursor: pointer; transition: color 0.2s; }
        .rating input[type="radio"]:checked ~ label,
        .rating label:hover,
        .rating label:hover ~ label { color: #F59E0B; } /* Amber-500 for stars */
        .rating input[type="radio"]:checked + label { color: #F59E0B; }

    </style>
</head>
<body class="flex flex-col min-h-screen">
<header class="bg-white shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="text-2xl font-bold text-gray-800"><a href="../index.html">Fitness <span class="accent-text">Center</span></a></div>
            <nav class="hidden md:flex items-center space-x-6">
                <a href="../index.html" class="text-gray-700 hover:text-lime-500">Home</a>
                <a href="../schedule.html" class="text-gray-700 hover:text-lime-500">Classes</a>
                <a href="member_dashboard.html" class="text-gray-700 hover:text-lime-500 font-semibold">My Dashboard</a>
            </nav>
            <div class="flex items-center space-x-3">
                <span class="hidden sm:inline text-gray-700">Welcome, Jane!</span> <a href="../index.html" class="btn-secondary text-sm sm:text-base !px-3 !py-1.5">Logout</a>
            </div>
            <div class="md:hidden"><button id="mobile-menu-button" class="text-gray-800 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button></div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden mt-3">
            <a href="index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Home</a>
            <a href="schedule.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Classes</a>
            <a href="member_dashboard.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded font-semibold">My Dashboard</a>
            <a href="index.html" class="block py-2 px-4 text-sm text-gray-700 hover:bg-lime-100 rounded">Logout</a>
        </div>
    </div>
</header>

<main class="flex-grow container mx-auto px-6 py-12 md:py-16">
    <div class="md:flex md:space-x-8">
        <aside class="md:w-1/4 mb-8 md:mb-0">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Member Menu</h3>
                <nav class="dashboard-nav space-y-1">
                    <a href="member_dashboard.html"><i class="fas fa-tachometer-alt mr-2 w-5 text-center"></i>Overview</a>
                    <a href="member_profile_update.html"><i class="fas fa-user-edit mr-2 w-5 text-center"></i>Update Profile</a>
                    <a href="member_booked_classes.html"><i class="fas fa-calendar-check mr-2 w-5 text-center"></i>My Bookings</a>
                    <a href="member_membership_details.html"><i class="fas fa-id-card mr-2 w-5 text-center"></i>Membership</a>
                    <a href="member_payment_history.html"><i class="fas fa-history mr-2 w-5 text-center"></i>Billing & Payments</a>
                    <a href="member_upgrade_downgrade.html"><i class="fas fa-level-up-alt mr-2 w-5 text-center"></i>Change Plan</a>
                    <a href="member_feedback_form.html" class="active"><i class="fas fa-comment-dots mr-2 w-5 text-center"></i>Submit Feedback</a>
                </nav>
            </div>
        </aside>

        <section class="md:w-3/4">
            <div class="bg-white p-8 md:p-10 rounded-xl shadow-2xl">
                <div class="mb-8">
                    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900">
                        Share Your <span class="accent-text">Feedback</span>
                    </h1>
                    <p class="mt-2 text-gray-600">We value your opinion! Help us improve our services.</p>
                </div>

                <form id="feedbackForm" class="space-y-6">
                    <div>
                        <label for="feedbackType" class="form-label">Feedback Type</label>
                        <select id="feedbackType" name="feedbackType" class="form-input" required>
                            <option value="" disabled selected>Select type...</option>
                            <option value="general">General Feedback</option>
                            <option value="class">Class Feedback</option>
                            <option value="trainer">Trainer Feedback</option>
                            <option value="facility">Facility Feedback</option>
                            <option value="suggestion">Suggestion</option>
                        </select>
                    </div>

                    <div id="classSpecificFeedback" class="hidden space-y-4">
                        <div>
                            <label for="classNameFeedback" class="form-label">Class Name</label>
                            <input type="text" id="classNameFeedback" name="classNameFeedback" class="form-input" placeholder="e.g., Sunrise Yoga on Monday">
                        </div>
                        <div>
                            <label for="classDateFeedback" class="form-label">Date of Class</label>
                            <input type="date" id="classDateFeedback" name="classDateFeedback" class="form-input">
                        </div>
                    </div>
                    <div id="trainerSpecificFeedback" class="hidden">
                        <label for="trainerNameFeedback" class="form-label">Trainer Name</label>
                        <input type="text" id="trainerNameFeedback" name="trainerNameFeedback" class="form-input" placeholder="e.g., Anna K.">
                    </div>

                    <div>
                        <label for="rating" class="form-label">Overall Rating (Optional)</label>
                        <div class="rating flex flex-row-reverse justify-end items-center"> <input type="radio" id="star5" name="rating" value="5"><label for="star5" title="5 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star4" name="rating" value="4"><label for="star4" title="4 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star3" name="rating" value="3"><label for="star3" title="3 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star2" name="rating" value="2"><label for="star2" title="2 stars"><i class="fas fa-star"></i></label>
                            <input type="radio" id="star1" name="rating" value="1"><label for="star1" title="1 star"><i class="fas fa-star"></i></label>
                        </div>
                    </div>

                    <div>
                        <label for="comments" class="form-label">Your Comments/Suggestions</label>
                        <textarea id="comments" name="comments" rows="5" class="form-input" placeholder="Tell us more..." required></textarea>
                    </div>

                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="anonymousFeedback" name="anonymousFeedback" class="h-4 w-4 text-lime-600 border-gray-300 rounded focus:ring-lime-500 mr-2">
                            <span class="text-sm text-gray-700">Submit Anonymously</span>
                        </label>
                    </div>

                    <div class="pt-4">
                        <button type="submit" class="btn-primary w-full text-lg">Submit Feedback</button>
                    </div>
                </form>
                <div id="feedbackMessage" class="mt-6 text-center"></div>
            </div>
        </section>
    </div>
</main>

<footer class="bg-gray-800 text-gray-300 py-12 mt-auto">
    <div class="container mx-auto px-6 text-center">
        <p>&copy; <span id="currentYear"></span> Fitness Center. All Rights Reserved.</p>
    </div>
</footer>

<script>
    // API Base URL
    const API_BASE_URL = 'http://localhost:8080/api'; // Adjust port if needed

    // DOM Elements
    const feedbackTypeSelect = document.getElementById('feedbackType');
    const classSpecificFeedbackDiv = document.getElementById('classSpecificFeedback');
    const trainerSpecificFeedbackDiv = document.getElementById('trainerSpecificFeedback');
    const feedbackForm = document.getElementById('feedbackForm');
    const feedbackMessage = document.getElementById('feedbackMessage');
    // Input fields for conditional sections
    const classNameFeedbackInput = document.getElementById('classNameFeedback');
    const classDateFeedbackInput = document.getElementById('classDateFeedback');
    const trainerNameFeedbackInput = document.getElementById('trainerNameFeedback');
    const commentsInput = document.getElementById('comments');
    const anonymousCheckbox = document.getElementById('anonymousFeedback');


    let currentMemberId = null;
    let authToken = null;

    function checkLoginStatus() {
        authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        currentMemberId = localStorage.getItem('memberId') || sessionStorage.getItem('memberId');

        if (!authToken || !currentMemberId) {
            alert('You must be logged in to submit feedback. Redirecting to login...');
            window.location.href = '../login.html'; // Adjust path
            return false;
        }
        return true;
    }

    function toggleConditionalFeedbackFields() {
        const selectedType = feedbackTypeSelect.value;

        if (classSpecificFeedbackDiv) classSpecificFeedbackDiv.classList.add('hidden');
        if (trainerSpecificFeedbackDiv) trainerSpecificFeedbackDiv.classList.add('hidden');

        // Clear and remove required from conditional inputs when hidden
        if (classNameFeedbackInput) { classNameFeedbackInput.value = ''; classNameFeedbackInput.required = false; }
        if (classDateFeedbackInput) { classDateFeedbackInput.value = ''; /* Not typically required */ }
        if (trainerNameFeedbackInput) { trainerNameFeedbackInput.value = ''; trainerNameFeedbackInput.required = false; }


        if (selectedType === 'class') {
            if (classSpecificFeedbackDiv) classSpecificFeedbackDiv.classList.remove('hidden');
            if (classNameFeedbackInput) classNameFeedbackInput.required = true;
        } else if (selectedType === 'trainer') {
            if (trainerSpecificFeedbackDiv) trainerSpecificFeedbackDiv.classList.remove('hidden');
            if (trainerNameFeedbackInput) trainerNameFeedbackInput.required = true;
        }
    }


    if (feedbackTypeSelect) {
        feedbackTypeSelect.addEventListener('change', toggleConditionalFeedbackFields);
    }

    if (feedbackForm) {
        feedbackForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            if (!checkLoginStatus()) return; // Re-check just in case

            if (feedbackMessage) feedbackMessage.innerHTML = '';

            const feedbackType = feedbackTypeSelect.value;
            const comments = commentsInput.value;
            const ratingInput = document.querySelector('input[name="rating"]:checked');
            const rating = ratingInput ? parseInt(ratingInput.value) : null;
            const isAnonymous = anonymousCheckbox.checked;

            let targetName = null;
            if (feedbackType === 'class' && classNameFeedbackInput) {
                targetName = classNameFeedbackInput.value;
                if (classDateFeedbackInput && classDateFeedbackInput.value) {
                    targetName += ` (Date: ${classDateFeedbackInput.value})`;
                }
            } else if (feedbackType === 'trainer' && trainerNameFeedbackInput) {
                targetName = trainerNameFeedbackInput.value;
            } else if (feedbackType === 'facility' || feedbackType === 'suggestion' || feedbackType === 'general') {
                targetName = feedbackType.charAt(0).toUpperCase() + feedbackType.slice(1); // e.g., "General", "Facility"
            }


            const feedbackData = {
                memberId: isAnonymous ? null : currentMemberId,
                // reviewerName will be set by backend if memberId is provided and not anonymous
                anonymous: isAnonymous,
                feedbackType: feedbackType,
                targetName: targetName,
                rating: rating,
                comments: comments
                // submissionDate and status will be set by backend
            };
            if (!isAnonymous && !feedbackData.memberId) { // Should not happen if checkLoginStatus works
                 if (feedbackMessage) feedbackMessage.innerHTML = `<p class="text-red-500">Error: Member ID missing for non-anonymous feedback.</p>`;
                return;
            }


            const submitButton = feedbackForm.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
            }
            if (feedbackMessage) feedbackMessage.innerHTML = `<p class="text-blue-500">Submitting feedback...</p>`;

            try {
                const response = await fetch(`${API_BASE_URL}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Auth-Token': authToken
                    },
                    body: JSON.stringify(feedbackData)
                });

                if (response.ok) {
                    // const submittedFeedback = await response.json();
                    if (feedbackMessage) feedbackMessage.innerHTML = `<p class="text-green-500"><i class="fas fa-check-circle mr-2"></i>Thank you! Your feedback has been submitted successfully and is pending review.</p>`;
                    feedbackForm.reset(); // Reset form fields
                    toggleConditionalFeedbackFields(); // Hide conditional fields again
                } else {
                    const errorText = await response.text();
                    if (feedbackMessage) feedbackMessage.innerHTML = `<p class="text-red-500">Failed to submit feedback: ${errorText || response.statusText}</p>`;
                }

            } catch (error) {
                console.error('Error submitting feedback:', error);
                if (feedbackMessage) feedbackMessage.innerHTML = `<p class="text-red-500">An error occurred. Please try again later.</p>`;
            } finally {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Submit Feedback';
                }
            }
        });
    }

    // Mobile menu toggle & common footer/header logic
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenuButton && mobileMenu) {
        mobileMenuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
    }
    const currentYearElement = document.getElementById('currentYear');
    if (currentYearElement) {
        currentYearElement.textContent = new Date().getFullYear();
    }
    const welcomeSpan = document.querySelector('header span.text-gray-700');
    if (welcomeSpan) {
        const userName = localStorage.getItem('fullName') || sessionStorage.getItem('fullName');
        if (userName) welcomeSpan.textContent = `Welcome, ${userName.split(' ')[0]}!`;
    }
    const logoutButton = document.querySelector('header a.btn-secondary');
    if (logoutButton && logoutButton.textContent.toLowerCase() === 'logout') {
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.clear(); sessionStorage.clear();
            window.location.href = '../login.html'; // Adjust path
        });
    }

    // Initial check
    window.addEventListener('DOMContentLoaded', () => {
        if (!checkLoginStatus()) {
            // The checkLoginStatus function already handles redirection
            return;
        }
        toggleConditionalFeedbackFields(); // Initialize visibility based on default selection
    });
</script>
</body>
</html>
